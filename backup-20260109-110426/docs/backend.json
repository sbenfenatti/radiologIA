{
  "entities": {
    "XRayImage": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "XRayImage",
      "type": "object",
      "description": "Represents an X-ray image and its associated data.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the X-ray image."
        },
        "dentistId": {
          "type": "string",
          "description": "Reference to the Dentist who uploaded the image. (Relationship: Dentist 1:N XRayImage)"
        },
        "uploadDateTime": {
          "type": "string",
          "description": "The date and time when the X-ray image was uploaded.",
          "format": "date-time"
        },
        "fileLocation": {
          "type": "string",
          "description": "The location of the X-ray image file (e.g., URL or file path).",
          "format": "uri"
        },
        "analysisResultsId": {
          "type": "string",
          "description": "Reference to the AnalysisResults entity. (Relationship: AnalysisResults 1:1 XRayImage)"
        }
      },
      "required": [
        "id",
        "dentistId",
        "uploadDateTime",
        "fileLocation"
      ]
    },
    "Dentist": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Dentist",
      "type": "object",
      "description": "Represents a dentist using the application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the dentist."
        },
        "firstName": {
          "type": "string",
          "description": "The first name of the dentist."
        },
        "lastName": {
          "type": "string",
          "description": "The last name of the dentist."
        },
        "email": {
          "type": "string",
          "description": "The email address of the dentist.",
          "format": "email"
        },
        "practiceName": {
          "type": "string",
          "description": "The name of the dental practice."
        }
      },
      "required": [
        "id",
        "firstName",
        "lastName",
        "email"
      ]
    },
    "AnalysisResults": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AnalysisResults",
      "type": "object",
      "description": "Represents the results of an AI analysis on an X-ray image.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the analysis results."
        },
        "xrayImageId": {
          "type": "string",
          "description": "Reference to the XRayImage entity. (Relationship: XRayImage 1:1 AnalysisResults)"
        },
        "findings": {
          "type": "string",
          "description": "Textual description of the AI analysis findings."
        },
        "trafficLight": {
          "type": "string",
          "description": "Traffic light indicator (e.g., green, yellow, red) representing the severity of the findings."
        },
        "segmentationData": {
          "type": "string",
          "description": "Data representing the segmented regions of interest in the X-ray image (e.g., JSON or other structured format)."
        }
      },
      "required": [
        "id",
        "xrayImageId",
        "findings",
        "trafficLight"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/dentists/{dentistId}",
        "definition": {
          "entityName": "Dentist",
          "schema": {
            "$ref": "#/backend/entities/Dentist"
          },
          "description": "Stores dentist profiles. DentistId is the same as the Firebase Auth UID.",
          "params": [
            {
              "name": "dentistId",
              "description": "The unique ID of the dentist, matching the Firebase Auth UID."
            }
          ]
        }
      },
      {
        "path": "/dentists/{dentistId}/xray_images/{xrayImageId}",
        "definition": {
          "entityName": "XRayImage",
          "schema": {
            "$ref": "#/backend/entities/XRayImage"
          },
          "description": "Stores X-ray images uploaded by each dentist. Includes denormalized 'dentistId' for authorization independence.",
          "params": [
            {
              "name": "dentistId",
              "description": "The unique ID of the dentist who owns the X-ray image."
            },
            {
              "name": "xrayImageId",
              "description": "The unique ID of the X-ray image."
            }
          ]
        }
      },
      {
        "path": "/dentists/{dentistId}/xray_images/{xrayImageId}/analysis_results/{analysisResultsId}",
        "definition": {
          "entityName": "AnalysisResults",
          "schema": {
            "$ref": "#/backend/entities/AnalysisResults"
          },
          "description": "Stores the analysis results for each X-ray image.",
          "params": [
            {
              "name": "dentistId",
              "description": "The unique ID of the dentist who owns the X-ray image."
            },
            {
              "name": "xrayImageId",
              "description": "The unique ID of the X-ray image."
            },
            {
              "name": "analysisResultsId",
              "description": "The unique ID of the analysis results."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to ensure authorization independence, clarity, and scalability. It leverages path-based ownership for dentist-owned data and denormalization where needed to avoid complex security rules with `get()` calls. This approach simplifies security rules, enhances debuggability, and supports efficient list operations.\n\n*   **Dentists:** Dentists are stored at the root level in the `dentists` collection.\n*   **X-Ray Images:** X-ray images are stored as subcollections under each dentist (`/dentists/{dentistId}/xray_images/{xrayImageId}`). This ensures clear ownership and allows for easy querying of images belonging to a specific dentist.\n*   **Analysis Results:** Analysis results are stored as subcollections under each X-ray image (`/dentists/{dentistId}/xray_images/{xrayImageId}/analysis_results/{analysisResultsId}`). This maintains a clear hierarchical relationship between dentists, their images, and the analysis results.\n\n**Authorization Independence (Denormalization):**\nThe `xray_images` subcollection stores the `dentistId` in each document. This allows us to enforce security rules based on the `request.auth.uid` matching the `dentistId` without needing to `get()` the parent dentist document.\n\n**QAPs (Rules Are Not Filters):**\nThe structure supports secure list operations by segregating data based on ownership. The path-based ownership ensures that a dentist can only access their own X-ray images and analysis results. This segregation inherently supports the QAP principle, as rules can be written to allow listing only resources owned by the authenticated user, without needing to filter based on document content.\n\n**Epidemiological Data (Future Considerations):**\nFor the epidemiological dashboard, which displays anonymized statistical data, consider a separate collection (e.g., `/epidemiological_data`). An automated process (e.g., a Cloud Function triggered by new analysis results) can aggregate and anonymize the data before storing it in this collection. Security rules for this collection can be configured to allow read access to all authenticated dentists while preventing any write access."
  }
}