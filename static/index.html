<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RadiologIA - Apoio Diagn√≥stico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: #1e293b; /* slate-800 */
            background: linear-gradient(-45deg, #b3d1ff, #c2e6d0, #fff9c4, #b3d1ff);
            background-size: 400% 400%;
            animation: gradientBG 40s ease infinite;
            overflow: hidden; 
        }

        #background-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-track { background: transparent; }
        .chat-container::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.2); border-radius: 20px; }
        #image-container { position: relative; width: 100%; height: 100%; overflow: hidden; display: flex; justify-content: center; align-items: center; cursor: crosshair; }
        #radiograph-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        #overlay-canvas, #spotlight-canvas { 
            position: absolute; 
            pointer-events: none;
        }

        .loader { border-top-color: #38bdf8; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        
        .glass-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            color: #334155;
            font-weight: 500;
        }
        .glass-button:hover {
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .finding-item { cursor: pointer; transition: background-color 0.2s; }
        .finding-item:hover { background-color: rgba(56, 189, 248, 0.2); }
        .thinking-bubble { display: flex; align-items: center; }
        .thinking-bubble span { height: 8px; width: 8px; margin: 0 2px; background-color: #475569; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .thinking-bubble .bounce1 { animation-delay: -0.32s; }
        .thinking-bubble .bounce2 { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .shake {
            animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
        }
    </style>
</head>
<body class="text-slate-800">
    <canvas id="background-canvas"></canvas>

    <div id="login-page" class="flex flex-col h-screen justify-center items-center p-4 relative">
        <img src="https://lh3.googleusercontent.com/d/1pnjD304jKuhy_O_YE-4kQDy42rJvjrCj" alt="RadiologIA Logo" class="h-24 w-auto mb-8">
        <div class="w-full max-w-sm flex flex-col items-center glass-effect rounded-2xl p-8">
            <h2 class="text-2xl font-bold mb-6">Acesso ao Prot√≥tipo</h2>
            <div class="w-full mb-4">
                <label for="password-input" class="block text-sm font-medium text-slate-600 mb-2">Senha de Acesso</label>
                <input type="password" id="password-input" class="w-full bg-slate-800/20 border border-slate-600/30 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500 text-slate-800 placeholder:text-slate-500">
                <p id="error-message" class="text-red-500 text-sm mt-2 h-4"></p>
            </div>
            <button id="login-button" class="w-full glass-button py-3 px-6 rounded-xl text-lg">
                Entrar
            </button>
        </div>
        <footer class="absolute bottom-4 left-1/2 -translate-x-1/2 glass-effect px-4 py-2 rounded-full">
            <span class="text-sm text-slate-700">Desenvolvido por: S√©rgio H. Benfenatti Botelho - DDS, LLM trainer - üáßüá∑</span>
        </footer>
    </div>


    <div id="welcome-page" class="hidden flex-col h-screen justify-center items-center p-4 relative">
        <img src="https://lh3.googleusercontent.com/d/1pnjD304jKuhy_O_YE-4kQDy42rJvjrCj" alt="RadiologIA Logo" class="h-24 w-auto mb-8">
        <div id="welcome-chat-container" class="w-full max-w-4xl h-1/2 flex flex-col glass-effect rounded-2xl">
        </div>
        <label for="image-upload-welcome" class="glass-button cursor-pointer py-3 px-6 rounded-xl mt-8 text-lg">
            Analisar Radiografia
        </label>
        <input type="file" id="image-upload-welcome" class="hidden" accept="image/*">
        <footer class="absolute bottom-4 left-1/2 -translate-x-1/2 glass-effect px-4 py-2 rounded-full">
             <span class="text-sm text-slate-700">Desenvolvido por: S√©rgio H. Benfenatti Botelho - DDS, LLM trainer - üáßüá∑</span>
        </footer>
    </div>

    <div id="analysis-page" class="hidden h-screen flex-col relative">
        <header class="glass-effect m-2.5 rounded-2xl flex justify-between items-center z-10 p-4">
            <div class="flex items-center space-x-3">
                <img src="https://lh3.googleusercontent.com/d/1pnjD304jKuhy_O_YE-4kQDy42rJvjrCj" alt="RadiologIA Logo" class="h-10 w-auto">
            </div>
            <div class="flex items-center space-x-4">
                 <label for="image-upload-analysis" class="glass-button cursor-pointer py-2 px-5 rounded-xl">
                    Carregar Nova
                </label>
                <input type="file" id="image-upload-analysis" class="hidden" accept="image/*">
                <button id="analyze-btn" class="glass-button py-2 px-5 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Analisar Imagem
                </button>
            </div>
        </header>

        <main class="flex-grow flex flex-col md:flex-row overflow-hidden p-2.5 pt-0 gap-2.5">
            <div id="viewer-panel" class="w-full md:w-2/3 h-1/2 md:h-full glass-effect rounded-2xl p-4 flex flex-col items-center justify-center relative overflow-hidden">
                <div id="image-container" class="hidden">
                    <img id="radiograph-img" alt="Radiografia a ser analisada" class="rounded-md shadow-lg">
                    <canvas id="overlay-canvas"></canvas>
                    <canvas id="spotlight-canvas"></canvas>
                </div>
                 <div id="viewer-placeholder" class="text-center text-slate-500 flex flex-col justify-center items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.158 0L10.5 9.75M10.5 12a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" /></svg>
                    <p class="mt-4 text-lg">Carregue uma radiografia para come√ßar.</p>
                </div>
                <div id="loader" class="hidden absolute inset-0 glass-effect flex-col items-center justify-center z-20">
                    <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-400 h-24 w-24 mb-4"></div>
                    <p class="text-xl font-semibold">Analisando com IA...</p>
                </div>
            </div>

            <div id="analysis-chat-container" class="w-full md:w-1/3 h-1/2 md:h-full flex flex-col glass-effect rounded-2xl overflow-hidden">
            </div>
        </main>
        <footer class="absolute bottom-2 left-1/2 -translate-x-1/2 glass-effect px-4 py-2 rounded-full">
             <span class="text-sm text-slate-700">Desenvolvido por: S√©rgio H. Benfenatti Botelho - DDS, LLM trainer - üáßüá∑</span>
        </footer>
    </div>

    <div id="chat-template" class="hidden">
        <div class="p-4 border-b border-black/10 flex items-center justify-between">
            <h2 class="text-lg font-semibold">IAssistente Cl√≠nico</h2>
        </div>
        <div class="chat-container flex-grow p-4 overflow-y-auto space-y-4"></div>
        <div class="p-4 border-t border-black/10">
            <div class="flex space-x-3 items-center">
                <input type="text" class="chat-input flex-grow bg-white/30 border border-slate-900/20 px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 placeholder:text-slate-500">
                <button class="chat-send glass-button rounded-lg p-2.5">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M12 5l7 7-7 7"/><path d="M5 12h14"/></svg>
                </button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- L√≥gica do Fundo com Canvas ---
            const bgCanvas = document.getElementById('background-canvas');
            const bgCtx = bgCanvas.getContext('2d');
            let shapes = [];
            function resizeCanvas() { bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight; }
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            const shapeTypes = ['circle', 'square', 'triangle'];
            const colors = ['rgba(179, 209, 255, 0.5)', 'rgba(194, 230, 208, 0.5)', 'rgba(255, 249, 196, 0.5)'];
            const shapeCount = 12;
            class Shape {
                constructor() { this.type = shapeTypes[Math.floor(Math.random() * shapeTypes.length)]; this.size = Math.random() * 80 + 60; this.x = Math.random() * bgCanvas.width; this.y = Math.random() * bgCanvas.height; this.vx = (Math.random() - 0.5) * 0.5; this.vy = (Math.random() - 0.5) * 0.5; this.color = colors[Math.floor(Math.random() * colors.length)]; }
                draw() { bgCtx.fillStyle = this.color; bgCtx.beginPath(); if (this.type === 'circle') { bgCtx.arc(this.x, this.y, this.size / 2, 0, Math.PI * 2); } else if (this.type === 'square') { bgCtx.rect(this.x - this.size / 2, this.y - this.size / 2, this.size, this.size); } else if (this.type === 'triangle') { bgCtx.moveTo(this.x, this.y - this.size / 2); bgCtx.lineTo(this.x - this.size / 2, this.y + this.size / 2); bgCtx.lineTo(this.x + this.size / 2, this.y + this.size / 2); bgCtx.closePath(); } bgCtx.fill(); }
                update() { if (this.x < 0 || this.x > bgCanvas.width) this.vx *= -1; if (this.y < 0 || this.y > bgCanvas.height) this.vy *= -1; this.x += this.vx; this.y += this.vy; }
            }
            function initShapes() { shapes = []; for (let i = 0; i < shapeCount; i++) { shapes.push(new Shape()); } }
            function animateBackground() { bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height); shapes.forEach(shape => { shape.update(); shape.draw(); }); requestAnimationFrame(animateBackground); }
            initShapes();
            animateBackground();

            // --- Vari√°veis Globais e Constantes ---
            const DEMO_PASSWORD = 'rad2025'; 
            const loginPage = document.getElementById('login-page');
            const welcomePage = document.getElementById('welcome-page');
            const analysisPage = document.getElementById('analysis-page');
            const passwordInput = document.getElementById('password-input');
            const loginButton = document.getElementById('login-button');
            const errorMessage = document.getElementById('error-message');
            const welcomeChatContainerEl = document.getElementById('welcome-chat-container');
            const analysisChatContainerEl = document.getElementById('analysis-chat-container');
            const chatTemplate = document.getElementById('chat-template');
            welcomeChatContainerEl.innerHTML = chatTemplate.innerHTML;
            analysisChatContainerEl.innerHTML = chatTemplate.innerHTML;
            const chatContainers = document.querySelectorAll('.chat-container');
            const chatInputs = document.querySelectorAll('.chat-input');
            const chatSends = document.querySelectorAll('.chat-send');
            const imageUploadWelcome = document.getElementById('image-upload-welcome');
            const imageUploadAnalysis = document.getElementById('image-upload-analysis');
            const radiographImg = document.getElementById('radiograph-img');
            const imageContainer = document.getElementById('image-container');
            const viewerPlaceholder = document.getElementById('viewer-placeholder');
            const analyzeBtn = document.getElementById('analyze-btn');
            const loader = document.getElementById('loader');
            const overlayCanvas = document.getElementById('overlay-canvas');
            const overlayCtx = overlayCanvas.getContext('2d');
            const spotlightCanvas = document.getElementById('spotlight-canvas');
            const spotlightCtx = spotlightCanvas.getContext('2d');
            
            let analysisResults = [];
            let currentImageFile = null;
            let chatHistory = [];
            let activeFinding = null;
            let hoveredFinding = null;
            let isAnalyzing = false; // <-- CORRE√á√ÉO: Flag para prevenir an√°lises m√∫ltiplas

            // --- Fun√ß√µes Principais ---
            const handleLogin = () => {
                if (passwordInput.value === DEMO_PASSWORD) {
                    loginPage.classList.add('hidden');
                    welcomePage.classList.remove('hidden');
                    welcomePage.classList.add('flex');
                    initializeChat();
                } else {
                    errorMessage.textContent = 'Senha incorreta.';
                    passwordInput.classList.add('shake');
                    setTimeout(() => {
                        passwordInput.classList.remove('shake');
                        errorMessage.textContent = '';
                    }, 1000);
                }
            };
            
            const initViewer = (imgSrc) => {
                viewerPlaceholder.classList.add('hidden');
                imageContainer.classList.remove('hidden');
                radiographImg.src = imgSrc;
                analyzeBtn.disabled = false;
                radiographImg.onload = () => {
                    adjustAllCanvases();
                    if (activeFinding) drawFinding(activeFinding);
                };
            };
            
            const adjustAllCanvases = () => {
                const img = radiographImg;
                const { naturalWidth, naturalHeight, clientWidth, clientHeight } = img;
                if (!naturalWidth || !naturalHeight) return;
                const top = (imageContainer.clientHeight - clientHeight) / 2;
                const left = (imageContainer.clientWidth - clientWidth) / 2;
                [overlayCanvas, spotlightCanvas].forEach(canvas => {
                    canvas.style.width = `${clientWidth}px`;
                    canvas.style.height = `${clientHeight}px`;
                    canvas.style.top = `${top}px`;
                    canvas.style.left = `${left}px`;
                    canvas.width = clientWidth;
                    canvas.height = clientHeight;
                });
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    currentImageFile = file;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        welcomePage.classList.add('hidden');
                        analysisPage.classList.remove('hidden');
                        analysisPage.classList.add('flex');
                        initViewer(event.target.result);
                        clearAllCanvases();
                        // Dispara a an√°lise automaticamente ap√≥s o upload
                        runAnalysis();
                    }
                    reader.readAsDataURL(file);
                }
            };

            // CORRE√á√ÉO: A l√≥gica de an√°lise foi movida para sua pr√≥pria fun√ß√£o para melhor controle.
            async function runAnalysis() {
                if (!currentImageFile || isAnalyzing) return; // Verifica a flag

                isAnalyzing = true; // Ativa a trava
                loader.classList.remove('hidden');
                loader.classList.add('flex');
                clearAllCanvases();
                const formData = new FormData();
                formData.append('file', currentImageFile);

                try {
                    const response = await fetch('/analyze', { method: 'POST', body: formData });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Erro HTTP! status: ${response.status}`);
                    }
                    const data = await response.json();
                    analysisResults = data.findings;
                    displayFindingsList(analysisResults);
                } catch (error) {
                    console.error('Erro ao analisar imagem:', error);
                    addBotMessage(`<b>Falha na Conex√£o:</b> N√£o foi poss√≠vel conectar ao servidor de an√°lise.`);
                } finally {
                    loader.classList.add('hidden');
                    loader.classList.remove('flex');
                    isAnalyzing = false; // Libera a trava
                }
            }

            function displayFindingsList(findings) {
                const findingsCount = findings.length;
                let message = `An√°lise completa. Identifiquei ${findingsCount} achados. Clique para visualizar ou me fa√ßa uma pergunta.`;
                if(findingsCount === 0) { message = "An√°lise completa. Nenhum achado detectado."; }
                
                let findingsHtml = `<div class="glass-effect rounded-lg p-3 w-full"><p class="mb-3">${message}</p><div class="space-y-2">${findings.map(finding => `<div class="finding-item bg-white/20 p-2 rounded-md flex justify-between items-center" data-finding-id="${finding.id}"><span>${finding.label}</span><span class="text-xs text-slate-600">${(finding.confidence * 100).toFixed(0)}%</span></div>`).join('')}</div></div>`;
                addHtmlToAllChats(findingsHtml);

                document.querySelectorAll('.finding-item').forEach(item => {
                    const findingId = item.dataset.findingId;
                    const finding = analysisResults.find(f => f.id === findingId);
                    item.addEventListener('click', () => { activeFinding = finding; if (activeFinding) drawFinding(activeFinding); });
                    item.addEventListener('mouseenter', () => drawSpotlight(finding));
                    item.addEventListener('mouseleave', () => drawSpotlight(null));
                });
            }

            function drawFinding(findingToDraw) {
                clearCanvas(overlayCanvas);
                if (!findingToDraw || !findingToDraw.segmentation) return;
                const { width, height } = overlayCanvas;
                const points = findingToDraw.segmentation.map(p => [(p[0]/100) * width, (p[1]/100) * height]);
                overlayCtx.beginPath();
                overlayCtx.moveTo(points[0][0], points[0][1]);
                for (let i = 1; i < points.length; i++) { overlayCtx.lineTo(points[i][0], points[i][1]); }
                overlayCtx.closePath();
                overlayCtx.strokeStyle = '#fb923c';
                overlayCtx.lineWidth = 2;
                overlayCtx.fillStyle = "rgba(251, 146, 60, 0.4)";
                overlayCtx.stroke();
                overlayCtx.fill();
            }

            function drawSpotlight(finding) {
                clearCanvas(spotlightCanvas);
                if (!finding) return;
                const { width, height } = spotlightCanvas;
                const points = finding.segmentation.map(p => [(p[0]/100) * width, (p[1]/100) * height]);
                spotlightCtx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                spotlightCtx.fillRect(0, 0, width, height);
                spotlightCtx.globalCompositeOperation = 'destination-out';
                spotlightCtx.beginPath();
                spotlightCtx.moveTo(points[0][0], points[0][1]);
                for (let i = 1; i < points.length; i++) { spotlightCtx.lineTo(points[i][0], points[i][1]); }
                spotlightCtx.closePath();
                spotlightCtx.fillStyle = 'white';
                spotlightCtx.fill();
                spotlightCtx.globalCompositeOperation = 'source-over';
            }

            function isPointInPolygon(point, polygon) {
                const { x, y } = point;
                let isInside = false;
                for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                    const xi = polygon[i][0], yi = polygon[i][1];
                    const xj = polygon[j][0], yj = polygon[j][1];
                    const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                    if (intersect) isInside = !isInside;
                }
                return isInside;
            }
            
            function clearCanvas(canvas) { const ctx = canvas.getContext('2d'); ctx.clearRect(0, 0, canvas.width, canvas.height); }
            function clearAllCanvases() { clearCanvas(overlayCanvas); clearCanvas(spotlightCanvas); activeFinding = null; }
            function addHtmlToAllChats(html) { chatContainers.forEach(container => { container.insertAdjacentHTML('beforeend', `<div>${html}</div>`); container.scrollTop = container.scrollHeight; }); }
            function addBotMessage(message, thinking=false) { let msgHtml; if(thinking) { msgHtml = `<div class="flex justify-start"><div class="glass-effect rounded-lg p-3 max-w-sm"><div class="thinking-bubble"><span class="bounce1"></span><span class="bounce2"></span><span class="bounce3"></span></div></div></div>`; } else { msgHtml = `<div class="flex justify-start"><div class="glass-effect rounded-lg p-3 max-w-sm"><p class="text-slate-800">${message}</p></div></div>`; } addHtmlToAllChats(msgHtml); }
            function addUserMessage(message) { const msgHtml = `<div class="flex justify-end"><div class="bg-blue-500 text-white rounded-lg p-3 max-w-sm"><p>${message}</p></div></div>`; addHtmlToAllChats(msgHtml); }
            
            async function handleUserMessage(inputEl) {
                const message = inputEl.value.trim();
                if (!message) return;
                addUserMessage(message);
                chatInputs.forEach(input => input.value = '');
                addBotMessage('', true);
                let prompt;
                if (analysisResults.length > 0) {
                    const findingsContext = analysisResults.map(f => `- ${f.label} (Confian√ßa: ${(f.confidence*100).toFixed(0)}%)`).join('\n');
                    prompt = `Voc√™ √© a RadiologIA, uma IA assistente para dentistas. Seja profissional, conciso e responda sempre em portugu√™s do Brasil. Com base nos achados radiogr√°ficos abaixo, responda √† pergunta do usu√°rio.\n\nAchados detectados:\n${findingsContext}\n\nPergunta: "${message}"`;
                } else {
                    prompt = `Voc√™ √© a RadiologIA, uma IA assistente para dentistas. Seja profissional, conciso e responda sempre em portugu√™s do Brasil. Responda √† seguinte pergunta geral de odontologia: "${message}"`;
                }
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                try {
                    const response = await fetch('/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ history: chatHistory }) });
                    document.querySelectorAll('.thinking-bubble').forEach(el => { const wrapper = el.closest('.flex.justify-start'); if (wrapper) wrapper.remove(); });
                    if (!response.ok) { const errorBody = await response.json(); throw new Error(errorBody.error || `Erro do servidor: ${response.statusText}`); }
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts[0].text) {
                        const botResponse = result.candidates[0].content.parts[0].text.replace(/\*/g, '');
                        addBotMessage(botResponse);
                        chatHistory.push({ role: "model", parts: [{ text: botResponse }] });
                    } else { throw new Error("Formato de resposta da IA inv√°lido recebido do backend."); }
                } catch (error) {
                    console.error("Erro ao chamar o backend:", error);
                    document.querySelectorAll('.thinking-bubble').forEach(el => { const wrapper = el.closest('.flex.justify-start'); if (wrapper) wrapper.remove(); });
                    addBotMessage(`<b>Falha na Conex√£o:</b> N√£o foi poss√≠vel processar sua solicita√ß√£o. (${error.message})`);
                }
            }
            
            function initializeChat() {
                 chatSends.forEach((button, index) => { button.addEventListener('click', () => handleUserMessage(chatInputs[index])); });
                 chatInputs.forEach(input => { input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); handleUserMessage(input); } }); });
                 chatHistory = [];
                 addBotMessage("Ol√°! Sou seu IAssistente. Pode me fazer uma pergunta sobre odontologia ou carregar uma radiografia para an√°lise.");
            }

            // --- Event Listeners ---
            loginButton.addEventListener('click', handleLogin);
            passwordInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleLogin(); });
            window.addEventListener('resize', adjustAllCanvases);
            imageUploadWelcome.addEventListener('change', handleFileUpload);
            imageUploadAnalysis.addEventListener('change', handleFileUpload);
            analyzeBtn.addEventListener('click', runAnalysis); // O bot√£o agora tamb√©m usa a fun√ß√£o com trava
            imageContainer.addEventListener('mousemove', (e) => {
                if (analysisResults.length === 0) return;
                const rect = spotlightCanvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                let currentlyHovered = null;
                for (let i = analysisResults.length - 1; i >= 0; i--) {
                    const finding = analysisResults[i];
                    const { width, height } = spotlightCanvas;
                    const polygonPoints = finding.segmentation.map(p => [(p[0]/100) * width, (p[1]/100) * height]);
                    if (isPointInPolygon({ x: mouseX, y: mouseY }, polygonPoints)) { currentlyHovered = finding; break; }
                }
                if (hoveredFinding?.id !== currentlyHovered?.id) { hoveredFinding = currentlyHovered; drawSpotlight(hoveredFinding); }
            });
            imageContainer.addEventListener('mouseleave', () => { hoveredFinding = null; drawSpotlight(null); });
        });
    </script>
</body>
</html>
