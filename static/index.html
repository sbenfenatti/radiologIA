<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RadiologIA - Apoio Diagn√≥stico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: #1e293b; /* slate-800 */
            background: linear-gradient(-45deg, #b3d1ff, #c2e6d0, #fff9c4, #b3d1ff);
            background-size: 400% 400%;
            animation: gradientBG 40s ease infinite;
            overflow: hidden; 
        }

        #background-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-track { background: transparent; }
        .chat-container::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.2); border-radius: 20px; }
        
        #viewer-panel { overflow: hidden; } /* Essencial para conter o zoom */

        #image-zoom-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.4s ease-in-out; /* Anima√ß√£o do zoom */
        }
        
        #radiograph-img { 
            max-width: 100%; 
            max-height: 100%; 
            object-fit: contain;
        }
        
        #overlay-canvas { 
            position: absolute; 
            pointer-events: auto; /* Permite eventos de mouse no canvas */
            transition: opacity 0.3s ease;
        }

        .loader { border-top-color: #38bdf8; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        
        .glass-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            color: #334155; /* slate-700 */
            font-weight: 500;
        }
        .glass-button:hover {
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .finding-item { cursor: pointer; transition: background-color 0.2s; }
        .finding-item.highlighted { background-color: rgba(56, 189, 248, 0.3); }

        .thinking-bubble { display: flex; align-items: center; }
        .thinking-bubble span { height: 8px; width: 8px; margin: 0 2px; background-color: #475569; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .thinking-bubble .bounce1 { animation-delay: -0.32s; }
        .thinking-bubble .bounce2 { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .shake {
            animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
        }
    </style>
</head>
<body class="text-slate-800">
    <canvas id="background-canvas"></canvas>

    <div id="login-page" class="flex flex-col h-screen justify-center items-center p-4 relative">
        <img src="https://lh3.googleusercontent.com/d/1pnjD304jKuhy_O_YE-4kQDy42rJvjrCj" alt="RadiologIA Logo" class="h-24 w-auto mb-8">
        <div class="w-full max-w-sm flex flex-col items-center glass-effect rounded-2xl p-8">
            <h2 class="text-2xl font-bold mb-6">Acesso ao Prot√≥tipo</h2>
            <div class="w-full mb-4">
                <label for="password-input" class="block text-sm font-medium text-slate-600 mb-2">Senha de Acesso</label>
                <input type="password" id="password-input" class="w-full bg-slate-800/20 border border-slate-600/30 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500 text-slate-800 placeholder:text-slate-500">
                <p id="error-message" class="text-red-500 text-sm mt-2 h-4"></p>
            </div>
            <button id="login-button" class="w-full glass-button py-3 px-6 rounded-xl text-lg">
                Entrar
            </button>
        </div>
        <footer class="absolute bottom-4 left-1/2 -translate-x-1/2 glass-effect px-4 py-2 rounded-full">
            <span class="text-sm text-slate-700">Desenvolvido por: S√©rgio H. Benfenatti Botelho - DDS, LLM trainer - üáßüá∑</span>
        </footer>
    </div>


    <div id="welcome-page" class="hidden flex-col h-screen justify-center items-center p-4 relative">
        <img src="https://lh3.googleusercontent.com/d/1pnjD304jKuhy_O_YE-4kQDy42rJvjrCj" alt="RadiologIA Logo" class="h-24 w-auto mb-8">
        <div id="welcome-chat-container" class="w-full max-w-4xl h-1/2 flex flex-col glass-effect rounded-2xl">
        </div>
        <label for="image-upload-welcome" class="glass-button cursor-pointer py-3 px-6 rounded-xl mt-8 text-lg">
            Analisar Radiografia
        </label>
        <input type="file" id="image-upload-welcome" class="hidden" accept="image/*">
        <footer class="absolute bottom-4 left-1/2 -translate-x-1/2 glass-effect px-4 py-2 rounded-full">
             <span class="text-sm text-slate-700">Desenvolvido por: S√©rgio H. Benfenatti Botelho - DDS, LLM trainer - üáßüá∑</span>
        </footer>
    </div>

    <div id="analysis-page" class="hidden h-screen flex-col relative">
        <header class="glass-effect m-2.5 rounded-2xl flex justify-between items-center z-10 p-4">
            <div class="flex items-center space-x-3">
                <img src="https://lh3.googleusercontent.com/d/1pnjD304jKuhy_O_YE-4kQDy42rJvjrCj" alt="RadiologIA Logo" class="h-10 w-auto">
            </div>
            <div class="flex items-center space-x-4">
                 <label for="image-upload-analysis" class="glass-button cursor-pointer py-2 px-5 rounded-xl">
                    Carregar Nova
                </label>
                <input type="file" id="image-upload-analysis" class="hidden" accept="image/*">
                <button id="analyze-btn" class="hidden">Analisar</button> <!-- Bot√£o agora √© oculto -->
            </div>
        </header>

        <main class="flex-grow flex flex-col md:flex-row overflow-hidden p-2.5 pt-0 gap-2.5">
            <div id="viewer-panel" class="w-full md:w-2/3 h-1/2 md:h-full glass-effect rounded-2xl p-4 flex flex-col items-center justify-center relative">
                 <div id="viewer-placeholder" class="text-center text-slate-500 flex flex-col justify-center items-center z-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.158 0L10.5 9.75M10.5 12a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" /></svg>
                    <p class="mt-4 text-lg">Carregue uma radiografia para come√ßar.</p>
                </div>
                <div id="image-zoom-container">
                    <img id="radiograph-img" alt="Radiografia a ser analisada" class="rounded-md shadow-lg hidden">
                    <canvas id="overlay-canvas"></canvas>
                </div>
                <button id="reset-zoom-btn" class="hidden absolute bottom-6 right-6 glass-button rounded-full p-3 z-20">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M15 3h6v6"/><path d="M9 21H3v-6"/><path d="m3 15 4-4"/><path d="m21 9-4 4"/></svg>
                </button>
                <div id="loader" class="hidden absolute inset-0 glass-effect flex-col items-center justify-center z-20">
                    <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-400 h-24 w-24 mb-4"></div>
                    <p class="text-xl font-semibold">Analisando com IA...</p>
                </div>
            </div>

            <div id="analysis-chat-container" class="w-full md:w-1/3 h-1/2 md:h-full flex flex-col glass-effect rounded-2xl overflow-hidden">
            </div>
        </main>
        <footer class="absolute bottom-2 left-1/2 -translate-x-1/2 glass-effect px-4 py-2 rounded-full">
             <span class="text-sm text-slate-700">Desenvolvido por: S√©rgio H. Benfenatti Botelho - DDS, LLM trainer - üáßüá∑</span>
        </footer>
    </div>

    <div id="chat-template" class="hidden">
        <div class="p-4 border-b border-black/10 flex items-center justify-between">
            <h2 class="text-lg font-semibold">IAssistente Cl√≠nico</h2>
        </div>
        <div class="chat-container flex-grow p-4 overflow-y-auto space-y-4"></div>
        <div class="p-4 border-t border-black/10">
            <div class="flex space-x-3 items-center">
                <input type="text" class="chat-input flex-grow bg-white/30 border border-slate-900/20 px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 placeholder:text-slate-500">
                <button class="chat-send glass-button rounded-lg p-2.5">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M12 5l7 7-7 7"/><path d="M5 12h14"/></svg>
                </button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- IN√çCIO: L√≥gica do Fundo com Canvas (Sem altera√ß√µes) ---
            const bgCanvas = document.getElementById('background-canvas');
            const bgCtx = bgCanvas.getContext('2d');
            let shapes = [];

            function resizeCanvas() {
                bgCanvas.width = window.innerWidth;
                bgCanvas.height = window.innerHeight;
            }
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            const shapeTypes = ['circle', 'square', 'triangle'];
            const colors = [
                'rgba(179, 209, 255, 0.5)', 
                'rgba(194, 230, 208, 0.5)',
                'rgba(255, 249, 196, 0.5)'
            ];
            const shapeCount = 12;

            class Shape {
                constructor() {
                    this.type = shapeTypes[Math.floor(Math.random() * shapeTypes.length)];
                    this.size = Math.random() * 80 + 60;
                    this.x = Math.random() * bgCanvas.width;
                    this.y = Math.random() * bgCanvas.height;
                    this.vx = (Math.random() - 0.5) * 0.5;
                    this.vy = (Math.random() - 0.5) * 0.5;
                    this.color = colors[Math.floor(Math.random() * colors.length)];
                }

                draw() {
                    bgCtx.fillStyle = this.color;
                    bgCtx.beginPath();
                    if (this.type === 'circle') {
                        bgCtx.arc(this.x, this.y, this.size / 2, 0, Math.PI * 2);
                    } else if (this.type === 'square') {
                        bgCtx.rect(this.x - this.size / 2, this.y - this.size / 2, this.size, this.size);
                    } else if (this.type === 'triangle') {
                        bgCtx.moveTo(this.x, this.y - this.size / 2);
                        bgCtx.lineTo(this.x - this.size / 2, this.y + this.size / 2);
                        bgCtx.lineTo(this.x + this.size / 2, this.y + this.size / 2);
                        bgCtx.closePath();
                    }
                    bgCtx.fill();
                }

                update() {
                    if (this.x < 0 || this.x > bgCanvas.width) this.vx *= -1;
                    if (this.y < 0 || this.y > bgCanvas.height) this.vy *= -1;
                    this.x += this.vx;
                    this.y += this.vy;
                }
            }

            function initShapes() {
                shapes = [];
                for (let i = 0; i < shapeCount; i++) {
                    shapes.push(new Shape());
                }
            }

            function animateBackground() {
                bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
                shapes.forEach(shape => {
                    shape.update();
                    shape.draw();
                });
                requestAnimationFrame(animateBackground);
            }

            initShapes();
            animateBackground();
            // --- FIM: L√≥gica do Fundo com Canvas ---

            const DEMO_PASSWORD = 'rad2025'; 

            // --- Elementos da UI ---
            const loginPage = document.getElementById('login-page');
            const welcomePage = document.getElementById('welcome-page');
            const analysisPage = document.getElementById('analysis-page');
            const passwordInput = document.getElementById('password-input');
            const loginButton = document.getElementById('login-button');
            const errorMessage = document.getElementById('error-message');
            const welcomeChatContainerEl = document.getElementById('welcome-chat-container');
            const analysisChatContainerEl = document.getElementById('analysis-chat-container');
            const chatTemplate = document.getElementById('chat-template');
            const imageUploadWelcome = document.getElementById('image-upload-welcome');
            const imageUploadAnalysis = document.getElementById('image-upload-analysis');
            const imageZoomContainer = document.getElementById('image-zoom-container');
            const radiographImg = document.getElementById('radiograph-img');
            const viewerPlaceholder = document.getElementById('viewer-placeholder');
            const analyzeBtn = document.getElementById('analyze-btn');
            const loader = document.getElementById('loader');
            const canvas = document.getElementById('overlay-canvas');
            const ctx = canvas.getContext('2d');
            const resetZoomBtn = document.getElementById('reset-zoom-btn');
            
            // --- Estado da Aplica√ß√£o ---
            let analysisResults = [];
            let currentImageFile = null;
            let chatHistory = [];
            let activeFinding = null; // Achado clicado
            let hoveredFinding = null; // Achado sob o mouse

            // --- Mapa de Labels (Tradu√ß√£o) ---
            const labelMap = {
                "carie": "C√°rie",
                "lesao_periapical": "Les√£o Periapical",
                "calculo_dental": "C√°lculo Dental",
                "restauracao": "Restaura√ß√£o",
                "dente_ausente": "Dente Ausente",
                "implante": "Implante",
                "coroa": "Coroa",
            };

            const getFriendlyLabel = (label) => labelMap[label] || label.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

            // --- L√≥gica de Login ---
            const handleLogin = () => {
                if (passwordInput.value === DEMO_PASSWORD) {
                    loginPage.classList.add('hidden');
                    welcomePage.classList.remove('hidden');
                    welcomePage.classList.add('flex');
                    initializeChat(welcomeChatContainerEl, true);
                } else {
                    errorMessage.textContent = 'Senha incorreta.';
                    passwordInput.classList.add('shake');
                    setTimeout(() => {
                        passwordInput.classList.remove('shake');
                        errorMessage.textContent = '';
                    }, 1000);
                }
            };
            
            loginButton.addEventListener('click', handleLogin);
            passwordInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleLogin(); });

            // --- L√≥gica de Visualiza√ß√£o e Canvas ---
            const initViewer = (imgSrc) => {
                viewerPlaceholder.classList.add('hidden');
                radiographImg.src = imgSrc;
                radiographImg.classList.remove('hidden');
                
                radiographImg.onload = () => {
                    adjustCanvasToImage();
                    analyzeBtn.click(); // Inicia a an√°lise automaticamente
                };
            };
            
            const adjustCanvasToImage = () => {
                const img = radiographImg;
                const { clientWidth, clientHeight } = img;
                if (!clientWidth || !clientHeight) return;
                const container = imageZoomContainer;
                const top = (container.clientHeight - clientHeight) / 2;
                const left = (container.clientWidth - clientWidth) / 2;
                canvas.style.width = `${clientWidth}px`;
                canvas.style.height = `${clientHeight}px`;
                canvas.style.top = `${top}px`;
                canvas.style.left = `${left}px`;
                canvas.width = clientWidth;
                canvas.height = clientHeight;
            };

            window.addEventListener('resize', () => {
                adjustCanvasToImage();
                redrawAllAnnotations();
            });

            // --- L√≥gica de Upload e An√°lise ---
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    // --- CORRE√á√ÉO: Reset completo do estado da an√°lise ---
                    currentImageFile = file;
                    analysisResults = [];
                    chatHistory = [];
                    activeFinding = null;
                    hoveredFinding = null;
                    
                    // Limpa a interface do chat de an√°lise
                    const chatContainer = analysisChatContainerEl.querySelector('.chat-container');
                    if (chatContainer) chatContainer.innerHTML = '';
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        welcomePage.classList.add('hidden');
                        analysisPage.classList.remove('hidden');
                        analysisPage.classList.add('flex');
                        resetZoom();
                        initViewer(event.target.result);
                    }
                    reader.readAsDataURL(file);
                }
            };
            
            imageUploadWelcome.addEventListener('change', handleFileUpload);
            imageUploadAnalysis.addEventListener('change', handleFileUpload);

            analyzeBtn.addEventListener('click', async () => {
                if (!currentImageFile) return;
                loader.classList.remove('hidden');
                loader.classList.add('flex');
                clearCanvas();
                const formData = new FormData();
                formData.append('file', currentImageFile);
                try {
                    const response = await fetch('/analyze', { method: 'POST', body: formData });
                    if (!response.ok) throw new Error(`Erro HTTP! status: ${response.status}`);
                    const data = await response.json();
                    analysisResults = data.findings;
                    displayFindingsList(analysisResults);
                } catch (error) {
                    console.error('Erro ao analisar imagem:', error);
                    addBotMessage(`<b>Falha na Conex√£o:</b> N√£o foi poss√≠vel conectar ao servidor de an√°lise.`);
                } finally {
                    loader.classList.add('hidden');
                    loader.classList.remove('flex');
                }
            });

            // --- Fun√ß√µes de Desenho e Interatividade ---
            function displayFindingsList(findings) {
                const findingsCount = findings.length;
                let message = `An√°lise completa. Identifiquei ${findingsCount} achado(s). Clique para dar zoom ou passe o mouse na imagem para destacar.`;
                if(findingsCount === 0) { message = "An√°lise completa. Nenhum achado detectado."; }
                
                let findingsHtml = `<div class="glass-effect rounded-lg p-3 w-full"><p class="mb-3">${message}</p><div class="space-y-2">${findings.map(finding => `<div class="finding-item bg-white/20 p-2 rounded-md flex justify-between items-center" data-finding-id="${finding.id}"><span>${getFriendlyLabel(finding.label)}</span><span class="text-xs text-slate-600">${(finding.confidence * 100).toFixed(0)}%</span></div>`).join('')}</div></div>`;
                addHtmlMessage(findingsHtml, analysisChatContainerEl.querySelector('.chat-container'));

                document.querySelectorAll('.finding-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const findingId = item.dataset.findingId;
                        const finding = analysisResults.find(f => f.id === findingId);
                        if(finding) zoomToFinding(finding);
                    });
                });
            }
            
            function drawMask(finding, fillStyle, strokeStyle, lineWidth = 2) {
                if (!finding || !finding.segmentation) return;
                const { width, height } = canvas;
                const points = finding.segmentation.map(p => [(p[0]/100) * width, (p[1]/100) * height]);
                
                ctx.beginPath();
                ctx.moveTo(points[0][0], points[0][1]);
                for (let i = 1; i < points.length; i++) { ctx.lineTo(points[i][0], points[i][1]); }
                ctx.closePath();

                ctx.fillStyle = fillStyle;
                ctx.strokeStyle = strokeStyle;
                ctx.lineWidth = lineWidth;
                ctx.stroke();
                ctx.fill();
            }

            function clearCanvas() { 
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
            }

            function redrawAllAnnotations() {
                clearCanvas();
                if (activeFinding) {
                    drawMask(activeFinding, "rgba(251, 146, 60, 0.4)", '#fb923c', 3);
                }
                if (hoveredFinding && hoveredFinding.id !== activeFinding?.id) {
                    drawMask(hoveredFinding, "rgba(56, 189, 248, 0.4)", '#38bdf8', 3);
                }
            }

            // --- L√≥gica de Zoom ---
            function zoomToFinding(finding) {
                activeFinding = finding;
                const { width, height } = imageZoomContainer.getBoundingClientRect();
                const { segmentation } = finding;
                
                const xCoords = segmentation.map(p => p[0]);
                const yCoords = segmentation.map(p => p[1]);
                const minX = Math.min(...xCoords) / 100;
                const maxX = Math.max(...xCoords) / 100;
                const minY = Math.min(...yCoords) / 100;
                const maxY = Math.max(...yCoords) / 100;

                const centerX = (minX + maxX) / 2;
                const centerY = (minY + maxY) / 2;

                const zoomLevel = 2;
                const newX = -(centerX * width * zoomLevel - width / 2);
                const newY = -(centerY * height * zoomLevel - height / 2);

                imageZoomContainer.style.transform = `scale(${zoomLevel}) translate(${newX / zoomLevel}px, ${newY / zoomLevel}px)`;
                resetZoomBtn.classList.remove('hidden');
                redrawAllAnnotations();
            }

            function resetZoom() {
                activeFinding = null;
                imageZoomContainer.style.transform = 'scale(1) translate(0, 0)';
                resetZoomBtn.classList.add('hidden');
                redrawAllAnnotations();
            }
            resetZoomBtn.addEventListener('click', resetZoom);

            // --- L√≥gica de Destaque na Imagem ---
            function isPointInPolygon(point, polygon) {
                let isInside = false;
                const { x, y } = point;
                for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                    const xi = polygon[i][0], yi = polygon[i][1];
                    const xj = polygon[j][0], yj = polygon[j][1];
                    const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                    if (intersect) isInside = !isInside;
                }
                return isInside;
            }

            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const mousePoint = { x: e.clientX - rect.left, y: e.clientY - rect.top };
                
                let foundFinding = null;
                for (const finding of analysisResults) {
                    const polygon = finding.segmentation.map(p => [(p[0]/100) * canvas.width, (p[1]/100) * canvas.height]);
                    if (isPointInPolygon(mousePoint, polygon)) {
                        foundFinding = finding;
                        break;
                    }
                }

                document.querySelectorAll('.finding-item').forEach(item => item.classList.remove('highlighted'));

                if (foundFinding) {
                    if (hoveredFinding?.id !== foundFinding.id) {
                        hoveredFinding = foundFinding;
                        const listItem = document.querySelector(`.finding-item[data-finding-id="${foundFinding.id}"]`);
                        if (listItem) listItem.classList.add('highlighted');
                        redrawAllAnnotations();
                    }
                } else {
                    if (hoveredFinding) {
                        hoveredFinding = null;
                        redrawAllAnnotations();
                    }
                }
            });

            // --- Fun√ß√µes de Chat ---
            function addHtmlMessage(html, chatContainer) {
                 if(chatContainer) {
                    chatContainer.insertAdjacentHTML('beforeend', `<div>${html}</div>`);
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                 }
            }

            function addBotMessage(message, thinking=false) {
                const chatContainer = analysisChatContainerEl.querySelector('.chat-container');
                let msgHtml;
                if(thinking) {
                    msgHtml = `<div class="flex justify-start"><div class="glass-effect rounded-lg p-3 max-w-sm"><div class="thinking-bubble"><span class="bounce1"></span><span class="bounce2"></span><span class="bounce3"></span></div></div></div>`;
                } else {
                     msgHtml = `<div class="flex justify-start"><div class="glass-effect rounded-lg p-3 max-w-sm"><p class="text-slate-800">${message}</p></div></div>`;
                }
                addHtmlMessage(msgHtml, chatContainer);
            }

            function addUserMessage(message) {
                const chatContainer = analysisChatContainerEl.querySelector('.chat-container');
                const msgHtml = `<div class="flex justify-end"><div class="bg-blue-500 text-white rounded-lg p-3 max-w-sm"><p>${message}</p></div></div>`;
                addHtmlMessage(msgHtml, chatContainer);
            }

            async function handleUserMessage(inputEl) {
                const message = inputEl.value.trim();
                if (!message) return;

                addUserMessage(message);
                document.querySelectorAll('.chat-input').forEach(input => input.value = '');
                addBotMessage('', true); 
                
                let prompt;
                if (analysisResults.length > 0) {
                    const findingsContext = analysisResults.map(f => `- ${getFriendlyLabel(f.label)} (Confian√ßa: ${(f.confidence*100).toFixed(0)}%)`).join('\n');
                    prompt = `Voc√™ √© a RadiologIA, uma IA assistente para dentistas. Seja profissional, conciso e responda sempre em portugu√™s do Brasil. Com base nos achados radiogr√°ficos abaixo, responda √† pergunta do usu√°rio.\n\nAchados detectados:\n${findingsContext}\n\nPergunta: "${message}"`;
                } else {
                    prompt = `Voc√™ √© a RadiologIA, uma IA assistente para dentistas. Seja profissional, conciso e responda sempre em portugu√™s do Brasil. Responda √† seguinte pergunta geral de odontologia: "${message}"`;
                }
                
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                
                try {
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ history: chatHistory }) 
                    });

                    document.querySelectorAll('.thinking-bubble').forEach(el => el.closest('.flex.justify-start')?.remove());

                    if (!response.ok) throw new Error((await response.json()).error || 'Erro do servidor');
                    
                    const result = await response.json();
                    
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const botResponse = result.candidates[0].content.parts[0].text.replace(/\*/g, '');
                        addBotMessage(botResponse);
                        chatHistory.push({ role: "model", parts: [{ text: botResponse }] });
                    } else { 
                        throw new Error("Formato de resposta da IA inv√°lido."); 
                    }
                } catch (error) {
                    console.error("Erro ao chamar o backend:", error);
                    document.querySelectorAll('.thinking-bubble').forEach(el => el.closest('.flex.justify-start')?.remove());
                    addBotMessage(`<b>Falha na Conex√£o:</b> N√£o foi poss√≠vel processar sua solicita√ß√£o. (${error.message})`);
                }
            }
            
            function initializeChat(containerEl, isWelcome) {
                 containerEl.innerHTML = chatTemplate.innerHTML;
                 const chatInput = containerEl.querySelector('.chat-input');
                 const chatSendBtn = containerEl.querySelector('.chat-send');
                 
                 chatSendBtn.addEventListener('click', () => handleUserMessage(chatInput));
                 chatInput.addEventListener('keydown', (e) => {
                     if (e.key === 'Enter') {
                         e.preventDefault();
                         handleUserMessage(chatInput);
                     }
                 });

                 if (isWelcome) {
                    chatHistory = [];
                    addHtmlMessage(`<div class="flex justify-start"><div class="glass-effect rounded-lg p-3 max-w-sm"><p class="text-slate-800">Ol√°! Sou seu IAssistente. Pode me fazer uma pergunta sobre odontologia ou carregar uma radiografia para an√°lise.</p></div></div>`, containerEl.querySelector('.chat-container'));
                 }
            }

            initializeChat(welcomeChatContainerEl, true);
            initializeChat(analysisChatContainerEl, false);

        });
    </script>
</body>
</html>
